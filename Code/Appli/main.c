/******************************************************************************************
  Filename    : main.c
  
  Core        : RV32IMAFCB (SiFive E24 RISC-V)
  
  MCU         : BL602
    
  Author      : Chalandi Amine
 
  Owner       : Chalandi Amine
  
  Date        : 21.10.2025
  
  Description : Application main function
  
******************************************************************************************/

//-----------------------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------------------
#include <stdint.h> 
#include "BL602.h"
#include "riscv-csr.h"

//-----------------------------------------------------------------------------------------
// Defines
//-----------------------------------------------------------------------------------------
#define TIMEOUT_500MS  (uint64_t)5000000

//-----------------------------------------------------------------------------------------
// Macros
//-----------------------------------------------------------------------------------------

//-----------------------------------------------------------------------------------------
// Globals
//-----------------------------------------------------------------------------------------

//-----------------------------------------------------------------------------------------
// Function Prototypes
//-----------------------------------------------------------------------------------------
void __attribute__((interrupt)) Isr_TIMER_Interrupt (void);

//-----------------------------------------------------------------------------------------
/// \brief  
///
/// \param  
///
/// \return 
//-----------------------------------------------------------------------------------------
void main(void)
{
   /* configure IO4 as output */
   glb->GPIO_CFGCTL2.bit.reg_gpio_4_func_sel = 0x0bul;
   glb->GPIO_CFGCTL2.bit.reg_gpio_4_ie       = 0ul;
   glb->GPIO_CFGCTL2.bit.reg_gpio_4_drv      = 0x1ul;
   glb->GPIO_CFGCTL2.bit.reg_gpio_4_smt      = 0ul;
   glb->GPIO_CFGCTL34.bit.reg_gpio_4_oe      = 1ul;

   /* enabled selective hardware vectoring */
   CLIC_CFG |= 1ul;

   /* enable timer interrupt in CLIC vectored mode */
   CLIC_INTIE[7] = 1u;

   /* set the timeout to 500ms */
   CLIC_MTIMECMP = (uint64_t)(CLIC_MTIME + TIMEOUT_500MS);

   /* endless loop */
   while(1);
}

//-----------------------------------------------------------------------------------------
/// \brief  
///
/// \param  
///
/// \return 
//-----------------------------------------------------------------------------------------
void Isr_TIMER_Interrupt (void)
{
   /* toggle the IO4 pin */
   glb->GPIO_CFGCTL32.bit.reg_gpio_4_o ^= 1ul;

   /* set the timeout to 500ms */
   CLIC_MTIMECMP = (uint64_t)(CLIC_MTIME + TIMEOUT_500MS);
}
